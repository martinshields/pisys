
services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    ports:
      - "8112:8112"  # Deluge Web UI
      - "6881:6881"  # Deluge torrenting TCP
      - "6881:6881/udp"  # Deluge torrenting UDP
    environment:
      - TZ=Etc/UTC
      - PUID=1000
      - PGID=1000
      - VPN_SERVICE_PROVIDER=private internet access
      - OPENVPN_USER=REPLACE_ME
      - OPENVPN_PASSWORD=REPLACE_ME
    volumes:
      - ./gluetun:/gluetun
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ip addr show tun0 | grep 'inet ' >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 10s

  deluge:
    image: linuxserver/deluge:latest
    container_name: deluge
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - TZ=Etc/UTC
      - PUID=1000
      - PGID=1000
    volumes:
      - /mnt/storage/downloads/torrents:/downloads
      - /mnt/storage/medialibrary:/media
      - ./deluge-config:/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "cat < /dev/tcp/127.0.0.1/8112 >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 10s

  jellyfin:
    image: linuxserver/jellyfin:latest
    container_name: jellyfin
    ports:
      - "8096:8096"
    environment:
      - TZ=Etc/UTC
      - PUID=1000
      - PGID=1000
    volumes:
      - ./jellyfin-config:/config
      - /mnt/storage/medialibrary:/media
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "cat < /dev/tcp/127.0.0.1/8096 >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 15s

  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    ports:
      - "8989:8989"
    environment:
      - TZ=Etc/UTC
      - PUID=1000
      - PGID=1000
    volumes:
      - ./sonarr-config:/config
      - /mnt/storage/downloads:/downloads
      - /mnt/storage/medialibrary:/media
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "cat < /dev/tcp/127.0.0.1/8989 >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 15s

  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    ports:
      - "7878:7878"
    environment:
      - TZ=Etc/UTC
      - PUID=1000
      - PGID=1000
    volumes:
      - ./radarr-config:/config
      - /mnt/storage/downloads:/downloads
      - /mnt/storage/medialibrary:/media
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "cat < /dev/tcp/127.0.0.1/7878 >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 6
      start_period: 15s

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./portainer-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "cat < /dev/tcp/127.0.0.1/9000 >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "pgrep watchtower >/dev/null || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    network_mode: "host"
    environment:
      TZ: "Etc/UTC"
      WEBPASSWORD: "changeme"
      DNSMASQ_LISTENING: "local"
      REV_SERVER: "true"
      REV_SERVER_DOMAIN: "local"
      REV_SERVER_TARGET: "10.0.0.1"
    volumes:
      - ./pihole/etc-pihole:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "google.com"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s




